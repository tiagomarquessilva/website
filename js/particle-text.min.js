// 
// particleText
//  - build a word on canvas that is made up of
//    tons of tiny rad gravitational particles
// 
// @author Michael Roth <mroth@highbridgecreative.com>
// @version v0.0.3
// @licens MIT
String.prototype.size=function(t){var e=t||"12px arial",i=document.createElement("div"),a=document.createTextNode(this);i.appendChild(a),i.style.position="absolute",i.style["float"]="left",i.style["white-space"]="nowrap",i.style.visibility="hidden",i.style.font=e,document.body.appendChild(i);var n=i.clientWidth,s=i.clientHeight;return i.parentNode.removeChild(i),{height:s,width:n}},function(){for(var t=0,e=["webkit","moz"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),a=Math.max(0,16-(i-t)),n=window.setTimeout(function(){e(i+a)},a);return t=i+a,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var ParticleText=function(t,e){this.text=t||"TEXT",this.id=e.canvas||"canvas",this.canvas=null,this.canvasWidth=e.canvasWidth,this.canvasHeight=e.canvasHeight,this.ctx=null,this.font={size:e.font.size||12,family:e.font.family||"helvetica",color:e.font.color||"#000000",weight:e.font.weight||"bold"},this.mouse={x:9999,y:9999,d2c:0},this.disableAnim=!1,this.animId=null,this.startTime=null,this.particles=[],this.pixels=[],this.density=e.density||5,this.size=e.size||3,this.width=0,this.height=0,this.center={x:0,y:0},this.Particle=function(t,e){this.parent=t,this.x=e.x,this.y=e.y,this.size=e.size,this.color=e.color,this.origX=e.x,this.origY=e.y,this.vx=e.vx||0,this.vy=e.vy||0,this.vMax=e.vMax||3*Math.random()+2,this.PI2=2*Math.PI,this.orbit={speed:e.orbit.speed||3e3}},this.Particle.prototype.draw=function(){var t=this;t.parent.ctx.beginPath(),t.parent.ctx.arc(t.x,t.y,t.size/2,0,t.PI2),t.parent.ctx.fillStyle=t.color,t.parent.ctx.closePath(),t.parent.ctx.fill()},this.Particle.prototype.update=function(){var t=this;t.y+=t.vy,t.x+=t.vx;var e=15,i=.2,a=.09;if(9999==t.parent.mouse.x||9999==t.parent.mouse.y)t.x>t.origX?t.vx-=i:t.x<t.origX+.1&&t.x>t.origX-.1?t.vx=0:t.vx+=i,t.y>t.origY?t.vy-=i:t.y<t.origY+.1&&t.y>t.origY-.1?t.vy=0:t.vy+=i;else{var n={};if(n.x=t.parent.mouse.x,n.y=t.parent.mouse.y,n.dx=t.x-n.x,n.dy=t.y-n.y,n.radius=Math.sqrt(Math.pow(n.dx,2)+Math.pow(n.dy,2)),n.dTotal=Math.abs(n.dx)+Math.abs(n.dy),n.accX=2*Math.abs(n.dx)/n.dTotal*(1/n.radius)*e,n.accY=2*Math.abs(n.dy)/n.dTotal*(1/n.radius)*e,n.dx<0?t.vx+=n.accX:t.vx-=n.accX,n.dy<0?t.vy+=n.accY:t.vy-=n.accY,n.radius<20){t.vy=0,t.vx=0;var s=(new Date).getTime(),o=s-t.parent.startTime,r=t.PI2*(o/t.orbit.speed);t.x=t.x+Math.sin(r),t.y=t.y+Math.cos(r)}}t.vx=t.vx>0?t.vx>t.vMax?t.vMax:t.vx:t.vx<-1*t.vMax?-1*t.vMax:t.vx,t.vy=t.vy>0?t.vy>t.vMax?t.vMax:t.vy:t.vy<-1*t.vMax?-1*t.vMax:t.vy,t.vx>0?t.vx-=a:t.vx<0&&(t.vx+=a),t.vy>0?t.vy-=a:t.vy<0&&(t.vy+=a)},this.init()};ParticleText.prototype.updateMousePos=function(t){var e=this.canvas.getBoundingClientRect();return this.mouse.x=t.clientX-e.left,this.mouse.y=t.clientY-e.top,this.mouse},ParticleText.prototype.mousemove=function(t){var e=this.updateMousePos(t);this.mouse.x=e.x,this.mouse.y=e.y},ParticleText.prototype.mouseout=function(){this.mouse.x=9999,this.mouse.y=9999},ParticleText.prototype.getOffset=function(t){for(var e=0,i=0;t&&!isNaN(t.offsetLeft)&&!isNaN(t.offsetTop);)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}},ParticleText.prototype.animate=function(){var t=this,e=new Date;t.time=e.getTime();for(var i=t.particles.length;i>0;)t.particles[i-1].update(),i--;t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height);for(var i=t.particles.length;i>0;)t.particles[i-1].draw(),i--;return t.disableAnim?!0:void(t.animId=requestAnimationFrame(function(){t.animate()}))},ParticleText.prototype.checkPixel=function(t,e){if(!this.pixels[t])return!0;var i=this.pixels[t][e];return"undefined"==typeof i?!0:0==i.a},ParticleText.prototype.rasterize=function(){var t=this;t.particles=[],t.pizels=[],t.ctx.fillStyle=t.font.color,t.ctx.fillText(t.text,0,1.5*t.height);var e=t.ctx.getImageData(0,0,t.canvas.width,t.canvas.height);t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height);for(var i=e.data,a=i.length,n=0;a>n;n+=4){var s={r:i[n],g:i[n+1],b:i[n+2],a:i[n+3]},o=n/4%t.canvas.width,r=Math.floor(n/4/t.canvas.width);"undefined"==typeof t.pixels[r]&&(t.pixels[r]=[]),t.pixels[r][o]=s}for(var r=0,c=t.pixels.length;c>r;r++)for(var o=0,h=t.pixels[r].length;h>o;o++)if(!t.checkPixel(r,o)){var v=o%8*1e3+1e3;t.particles.push(new t.Particle(t,{color:t.font.color,size:t.size*(t.pixels[r][o].a/255),x:o*t.density+t.width+t.width/2,y:r*t.density-t.height*t.density/2,orbit:{speed:v+1e3}}))}},ParticleText.prototype.init=function(){var t=this,e=t.font.weight+" "+t.font.size+"px "+t.font.family;t.canvas=document.getElementById(t.id),t.width=t.text.size(e).width,t.height=t.text.size(e).height,t.canvas.width=t.canvasWidth||t.width*t.density+t.width*t.density*.4,t.canvas.height=t.canvasHeight||t.height*t.density+t.height*t.density*.4,t.ctx=t.canvas.getContext("2d"),t.ctx.font=e;var i=t.getOffset(t.canvas);t.canvas.x=i.x,t.canvas.y=i.y,t.center={x:t.canvas.x+t.width*t.density/2,y:t.canvas.y+t.height*t.density/2},t.canvas.addEventListener("mousemove",t.mousemove.bind(t)),t.canvas.addEventListener("mouseout",t.mouseout.bind(t)),setTimeout(function(){t.rasterize();var e=new Date;t.startTime=e.getTime(),t.animate()},10)},ParticleText.prototype.destroy=function(){var t=this;t.animId&&cancelAnimationFrame(t.animId),t.canvas.removeEventListener("mousemove",t.mousemove),t.canvas.removeEventListener("mouseout",t.mouseout);var e=document.getElementById(t.id);if(e&&e.parentNode){var i=e.parentNode;i.removeChild(e);var a=document.createElement("canvas");a.id=t.id,i.appendChild(a)}};
